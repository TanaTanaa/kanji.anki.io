<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ことばクイズ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    textarea, input, button, select { margin: 5px; font-size: 16px; }
    #quiz { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>ことばクイズ</h1>

  <textarea id="inputArea" rows="10" cols="50" placeholder="漢字,ひらがな 形式で入力（カンマ区切り・改行）"></textarea><br>
  <button onclick="loadData()">単語を読み込む</button>
  <button onclick="exportCSV()">CSVダウンロード</button>
  <button onclick="startQuiz()">クイズをはじめる</button>
  <button onclick="loadFromURL()">URLから読み込み</button><br>

  <select id="quizMode">
    <option value="kanjiToKana">漢字 → ひらがな</option>
    <option value="kanaToKanji">ひらがな → 漢字</option>
  </select>

  <div id="quiz"></div>
  <div id="buttons" style="margin-top: 15px;"></div>

  <button onclick="retryMistakes()">まちがいさいちょうせん</button>
  <button onclick="startQuiz()">もういちどクイズ</button>
  <button onclick="reviewMistakes()">まちがえたたんごでふくしゅう</button>

  <script>
    let wordList = [];
    let currentData = [];
    let currentIndex = 0;
    let mistakeList = [];
    let persistentMistakes = new Set();

    function loadData() {
      const input = document.getElementById("inputArea").value.trim();
      wordList = input.split("\n").map(line => {
        const [kanji, kana] = line.split(",");
        return { kanji: kanji.trim(), kana: kana.trim() };
      });
      alert("単語を読み込みました（" + wordList.length + "件）");
    }

    function exportCSV() {
      const csv = wordList.map(item => `${item.kanji},${item.kana}`).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "words.csv";
      a.click();
    }

    function startQuiz(data = wordList) {
      currentData = [...data];
      currentIndex = 0;
      mistakeList = [];
      showCurrentQuestion();
    }

    function showCurrentQuestion() {
      if (currentIndex >= currentData.length) {
        document.getElementById("quiz").innerHTML = "おわり！";
        document.getElementById("buttons").innerHTML = "";
        return;
      }

      const item = currentData[currentIndex];
      const mode = document.getElementById("quizMode").value;
      const question = mode === "kanjiToKana" ? item.kanji : item.kana;
      const answer = mode === "kanjiToKana" ? item.kana : item.kanji;

      document.getElementById("quiz").innerHTML = `
        <div>
          <p style="font-size: 24px;">もんだい：<strong>${question}</strong>
            <span id="answer" style="display:none;"> → ${answer}</span>
          </p>
          <div style="margin-top: 10px;">
            <button onclick="showAnswer()">こたえをみる</button>
          </div>
        </div>
      `;

      document.getElementById("buttons").innerHTML = `
        <button onclick="markCorrect()">〇</button>
        <button onclick="markIncorrect()">×</button>
      `;
    }

    function showAnswer() {
      document.getElementById("answer").style.display = "inline";
    }

    function markCorrect() {
      currentIndex++;
      showCurrentQuestion();
    }

    function markIncorrect() {
      const item = currentData[currentIndex];
      mistakeList.push(item);
      persistentMistakes.add(JSON.stringify(item));
      currentIndex++;
      showCurrentQuestion();
    }

    function retryMistakes() {
      if (mistakeList.length === 0) {
        alert("まちがえた単語はありません。");
        return;
      }
      startQuiz(mistakeList);
    }

    function reviewMistakes() {
      if (persistentMistakes.size === 0) {
        alert("まちがえた単語はありません。");
        return;
      }
      const uniqueMistakes = Array.from(persistentMistakes).map(json => JSON.parse(json));
      startQuiz(uniqueMistakes);
    }

    function loadFromURL() {
      const params = new URLSearchParams(window.location.search);
      if (params.has("data")) {
        const encoded = params.get("data");
        const decoded = decodeURIComponent(atob(encoded));
        document.getElementById("inputArea").value = decoded;
        loadData();
        startQuiz();
      } else {
        alert("URLにデータが見つかりません。");
      }
    }

    window.onload = loadFromURL;
  </script>
</body>
</html>

