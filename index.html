<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã«ã»ã‚“ã”ãã„ãšï¼ˆã˜ã“ã¯ã‚“ã¦ã„ã—ãï¼‰</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    padding: 20px;
  }
  textarea, input, button {
    margin: 5px;
    font-size: 16px;
  }
  .card {
    border: 2px solid #ccc;
    border-radius: 12px;
    padding: 20px;
    margin: 20px auto;
    width: 80%;
    max-width: 400px;
    font-size: 24px;
    background: #f9f9f9;
  }
  .word-list {
    margin-top: 20px;
    text-align: left;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
    font-size: 18px;
  }
</style>
</head>
<body>

<h1 id="main-title">ã«ã»ã‚“ã”ãã„ãšï¼ˆã˜ã“ã¯ã‚“ã¦ã„ã—ãï¼‰</h1>

<!-- ç·¨é›†ã‚¨ãƒªã‚¢ï¼ˆãµã¤ã†ã®ãƒšãƒ¼ã‚¸ã®ã¿è¡¨ç¤ºï¼‰ -->
<div id="edit-area">
  <textarea id="bulkInput" rows="6" cols="50" placeholder="ã‹ã‚“ã˜ã€ã‚ˆã¿ã‚’1ãã‚‡ã†ãšã¤ã«ã‚…ã†ã‚Šã‚‡ãã—ã¦ãã ã•ã„&#10;ã‚Œã„ï¼‰å·,ã‹ã‚"></textarea><br>
  <button onclick="addWords()">ãŸã‚“ã”ã‚’ã¤ã„ã‹</button>
  <button onclick="shareURL()">ãã‚‡ã†ã‚†ã†ã‚ˆã†URLã‚’ã›ã„ã›ã„</button><br>
  <input type="text" id="shareURL" readonly style="width:80%" onclick="this.select()" placeholder="ã“ã“ã«ãã‚‡ã†ã‚†ã†URLãŒã²ã‚‡ã†ã˜ã•ã‚Œã¾ã™">

  <h2>ğŸ“š ãŸã‚“ã”ãƒªã‚¹ãƒˆ</h2>
  <ul id="vocabList" class="word-list"></ul>
</div>

<!-- ã‚¯ã‚¤ã‚ºã‚¨ãƒªã‚¢ï¼ˆã„ã¤ã‚‚ã‚ã‚‹ã‘ã©URLãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦è¡¨ç¤º/éè¡¨ç¤ºï¼‰ -->
<div id="quizCard" class="card" style="display:none;">
  <div id="question"></div>
  <div id="progress" style="margin:10px 0; font-size:18px; color:#555;"></div>
  <button onclick="showAnswer()">ã“ãŸãˆã‚’ã¿ã‚‹</button>
  <div id="answer" style="display:none; margin-top:10px; font-size:22px; color:#007700;"></div>
  <button onclick="markCorrect()">ã¾ã‚‹ã€€ã›ã„ã‹ã„</button>
  <button onclick="markWrong()">ã°ã¤ã€€ã¾ã¡ãŒã„</button>
  <br>
  <button onclick="startOver()">ã•ã„ã—ã‚‡ã‹ã‚‰ã‚„ã‚ŠãªãŠã™</button>
</div>

<div id="result" style="margin-top:20px; font-size:18px;"></div>

<button id="startQuizBtn" onclick="startQuiz()">ãã„ãšã‚’ã¯ã˜ã‚ã‚‹</button>
<button id="retestBtn" onclick="startRetest()">ã¾ã¡ãŒãˆãŸãŸã‚“ã”ã§ã•ã„ã¦ã™ã¨</button>

<script>
let vocab = [];
let currentIndex = 0;
let usedIndices = [];
let wrongIndices = [];

const urlParams = new URLSearchParams(location.search);
const dataParam = urlParams.get("data");
const isQuizOnlyMode = !!dataParam;

function addWords() {
  const lines = document.getElementById("bulkInput").value.trim().split("\n");
  for (const line of lines) {
    const [kanji, reading] = line.split(",");
    if (kanji && reading) {
      vocab.push({ kanji: kanji.trim(), reading: reading.trim() });
    }
  }
  renderVocabList();
  alert("ãŸã‚“ã”ã‚’ã¤ã„ã‹ã—ã¾ã—ãŸ");
  document.getElementById("bulkInput").value = "";
}

function renderVocabList() {
  const list = document.getElementById("vocabList");
  list.innerHTML = "";
  vocab.forEach((word, index) => {
    const li = document.createElement("li");
    li.textContent = `${word.kanji} - ${word.reading} `;
    if (!isQuizOnlyMode) {
      const delBtn = document.createElement("button");
      delBtn.textContent = "ã•ãã˜ã‚‡";
      delBtn.onclick = () => {
        if (confirm("ã•ãã˜ã‚‡ã—ã¾ã™ã‹ï¼Ÿ")) {
          vocab.splice(index, 1);
          renderVocabList();
        }
      };
      li.appendChild(delBtn);
    }
    list.appendChild(li);
  });
}

function startQuiz() {
  if (vocab.length === 0) return alert("ãŸã‚“ã”ãŒã‚ã‚Šã¾ã›ã‚“");
  usedIndices = [];
  wrongIndices = [];
  document.getElementById("result").textContent = "";
  document.getElementById("quizCard").style.display = "block";
  document.getElementById("startQuizBtn").style.display = "none";
  if (!isQuizOnlyMode) {
    document.getElementById("edit-area").style.display = "none";
    document.getElementById("retestBtn").style.display = "inline-block";
  }
  nextQuestion();
}

function nextQuestion() {
  if (usedIndices.length === vocab.length) {
    document.getElementById("result").textContent = `ãŠã‚ã‚Šï¼ (${vocab.length - wrongIndices.length} ã›ã„ã‹ã„ / ${vocab.length})`;
    document.getElementById("quizCard").style.display = "none";
    document.getElementById("progress").textContent = "";
    document.getElementById("startQuizBtn").style.display = "inline-block";
    if (!isQuizOnlyMode) {
      document.getElementById("edit-area").style.display = "block";
      document.getElementById("retestBtn").style.display = "none";
    }
    return;
  }
  let index;
  do {
    index = Math.floor(Math.random() * vocab.length);
  } while (usedIndices.includes(index));
  currentIndex = index;
  usedIndices.push(index);

  // ã‚¯ã‚¤ã‚ºã ã‘ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã€Œã‚ˆã¿ã€ã ã‘è¡¨ç¤ºï¼ˆã²ã‚‰ãŒãªï¼‰ã€ãã†ã§ãªã‘ã‚Œã°ã‹ã‚“ã˜ï¼‹ã‚ˆã¿
  document.getElementById("question").textContent = isQuizOnlyMode ? vocab[index].reading : vocab[index].kanji;
  document.getElementById("answer").style.display = "none";
  document.getElementById("answer").textContent = isQuizOnlyMode ? vocab[index].kanji + "ï¼ˆ" + vocab[index].reading + "ï¼‰" : vocab[index].reading;

  document.getElementById("progress").textContent = `ã‚‚ã‚“ã ã„ ${usedIndices.length} / ${vocab.length}`;
}

function showAnswer() {
  document.getElementById("answer").style.display = "block";
}

function markCorrect() {
  nextQuestion();
}

function markWrong() {
  if (!wrongIndices.includes(currentIndex)) wrongIndices.push(currentIndex);
  nextQuestion();
}

function startRetest() {
  if (wrongIndices.length === 0) return alert("ã¾ã¡ãŒãˆãŸãŸã‚“ã”ãŒã‚ã‚Šã¾ã›ã‚“");
  vocab = wrongIndices.map(i => vocab[i]);
  usedIndices = [];
  wrongIndices = [];
  document.getElementById("result").textContent = "ã•ã„ã¦ã™ã¨ ã‹ã„ã—";
  document.getElementById("quizCard").style.display = "block";
  document.getElementById("startQuizBtn").style.display = "none";
  nextQuestion();
}

function startOver() {
  if (confirm("ã»ã‚“ã¨ã†ã« ã•ã„ã—ã‚‡ã‹ã‚‰ã‚„ã‚ŠãªãŠã—ã¾ã™ã‹ï¼Ÿ")) {
    usedIndices = [];
    wrongIndices = [];
    document.getElementById("quizCard").style.display = "none";
    document.getElementById("result").textContent = "";
    document.getElementById("progress").textContent = "";
    if (!isQuizOnlyMode) {
      document.getElementById("edit-area").style.display = "block";
      document.getElementById("retestBtn").style.display = "none";
    }
    document.getElementById("startQuizBtn").style.display = "inline-block";
  }
}

function shareURL() {
  if (vocab.length === 0) return alert("ãŸã‚“ã”ã‚’ã¤ã„ã‹ã—ã¦ãã ã•ã„");
  const json = JSON.stringify(vocab);
  const encoded = encodeURIComponent(btoa(unescape(encodeURIComponent(json))));
  const url = `${location.origin}${location.pathname}?data=${encoded}`;
  const input = document.getElementById("shareURL");
  input.value = url;
  input.select();
  navigator.clipboard.writeText(url);
  alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
}

function loadFromURL() {
  if (!isQuizOnlyMode) {
    // ãµã¤ã†ã®ãƒ¢ãƒ¼ãƒ‰ â†’ ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
    const saved = localStorage.getItem("nihongoVocab");
    if (saved) {
      try {
        vocab = JSON.parse(saved);
        renderVocabList();
      } catch {}
    }
  } else {
    // ãã‚‡ã†ã‚†ã†URLãƒ¢ãƒ¼ãƒ‰ â†’ URLã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    try {
      const decoded = decodeURIComponent(escape(atob(decodeURIComponent(dataParam))));
      vocab = JSON.parse(decoded);
      // ã‚¿ã‚¤ãƒˆãƒ«ã‹ãˆã‚‹
      document.getElementById("main-title").textContent = "ã«ã»ã‚“ã”ãã„ãš";
      // ç·¨é›†ã‚¨ãƒªã‚¢ã‹ãã™
      document.getElementById("edit-area").style.display = "none";
      // ã€Œã¾ã¡ãŒãˆãŸãŸã‚“ã”ã§ã•ã„ã¦ã™ã¨ã€ãƒœã‚¿ãƒ³ã¯è¡¨ç¤º
      document.getElementById("retestBtn").style.display = "inline-block";
      // ã€Œãã„ãšã‚’ã¯ã˜ã‚ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      document.getElementById("startQuizBtn").style.display = "inline-block";
    } catch {
      alert("URLã®ãªã„ã‚ˆã†ãŒã“ã‚ã‚Œã¦ã„ã¾ã™");
    }
  }
}

window.onload = () => {
  loadFromURL();
};

// ã˜ã©ã†ã»ãã‚“ï¼ˆãµã¤ã†ã®ãƒ¢ãƒ¼ãƒ‰ã ã‘ï¼‰
window.onbeforeunload = () => {
  if (!isQuizOnlyMode) {
    localStorage.setItem("nihongoVocab", JSON.stringify(vocab));
  }
};
</script>

</body>
</html>
