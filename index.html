<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ—¥æœ¬èªã‚¯ã‚¤ã‚ºï¼ˆæ¼¢å­—å­¦ç¿’ï¼‰</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      text-align: center;
    }
    textarea, input, button {
      margin: 5px;
      font-size: 16px;
    }
    .card {
      border: 2px solid #ccc;
      border-radius: 12px;
      padding: 20px;
      margin: 20px auto;
      width: 80%;
      max-width: 400px;
      font-size: 36px;
      user-select: none;
    }
    .word-list {
      margin-top: 20px;
      text-align: left;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      font-size: 18px;
    }
    .word-list li {
      margin: 4px 0;
    }
    #shareURL {
      width: 80%;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>æ—¥æœ¬èªã‚¯ã‚¤ã‚ºï¼ˆå°å­¦1å¹´ç”Ÿæ¼¢å­—ï¼‰</h1>
  <p>èª­ã¿ã‚’ç­”ãˆã‚‹è‡ªå·±åˆ¤å®šå¼ã‚¯ã‚¤ã‚ºã§ã™ã€‚æ¼¢å­—ã®èª­ã¿ã‚’æ›¸ã„ãŸã‚Šè¦šãˆãŸã‚Šã—ã¾ã—ã‚‡ã†ã€‚</p>

  <textarea id="bulkInput" rows="6" cols="50" placeholder="æ¼¢å­—,èª­ã¿ï¼ˆã²ã‚‰ãŒãªï¼‰ ã®ã‚ˆã†ã«å…¥åŠ›&#10;ä¾‹ï¼‰å±±,ã‚„ã¾&#10;å·,ã‹ã‚"></textarea><br>
  <button onclick="addWords()">å˜èªã‚’è¿½åŠ </button>
  <button onclick="startOver()">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
  <button onclick="exportCSV()">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  <button onclick="exportJSON()">JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button><br>
  
  <button onclick="generateShareURL()">å…±æœ‰ç”¨URLã‚’ä½œã‚‹</button><br>
  <input type="text" id="shareURL" readonly onclick="this.select()" placeholder="ã“ã“ã«å…±æœ‰URLãŒè¡¨ç¤ºã•ã‚Œã¾ã™"><br>
  
  <input type="file" id="importFile" accept=".json" />
  <button onclick="importData()">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</button>

  <div class="card" id="quizCard" style="display:none;">
    <div id="question" style="font-weight:bold;"></div>
    <div id="progress" style="margin: 10px 0; font-size: 18px; color: #555;"></div>
    <button onclick="showAnswer()">ã“ãŸãˆã‚’ã¿ã‚‹</button>
    <div id="answer" style="display:none; font-size: 24px; margin-top: 10px; color: #007700;"></div>
    <button onclick="markCorrect()">â—‹ æ­£è§£</button>
    <button onclick="markWrong()">Ã— ã¾ã¡ãŒã„</button>
  </div>

  <div id="result" style="margin-top:20px; font-size: 18px;"></div>

  <button onclick="startQuiz()">ã‚¯ã‚¤ã‚ºã‚’ã¯ã˜ã‚ã‚‹</button>
  <button onclick="startRetest()">ã¾ã¡ãŒãˆãŸå˜èªã§å†ãƒ†ã‚¹ãƒˆ</button>

  <h2>ğŸ“š å˜èªãƒªã‚¹ãƒˆ</h2>
  <ul id="vocabList" class="word-list"></ul>

  <script>
    let vocab = [];
    let currentIndex = 0;
    let usedIndices = [];
    let wrongIndices = [];

    function addWords() {
      const lines = document.getElementById("bulkInput").value.trim().split("\n");
      for (let line of lines) {
        const [kanji, reading] = line.split(",");
        if (kanji && reading) vocab.push({ kanji: kanji.trim(), reading: reading.trim() });
      }
      saveData();
      renderVocabList();
      document.getElementById("bulkInput").value = "";
      alert("å˜èªã‚’è¿½åŠ ã—ã¾ã—ãŸ");
    }

    function renderVocabList() {
      const list = document.getElementById("vocabList");
      list.innerHTML = "";
      vocab.forEach((word, index) => {
        const li = document.createElement("li");
        li.textContent = `${word.kanji} - ${word.reading} `;
        const delBtn = document.createElement("button");
        delBtn.textContent = "å‰Šé™¤";
        delBtn.onclick = () => {
          if (confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            vocab.splice(index, 1);
            saveData();
            renderVocabList();
          }
        };
        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }

    function startQuiz() {
      if (vocab.length === 0) return alert("å˜èªãŒã‚ã‚Šã¾ã›ã‚“");
      usedIndices = [];
      wrongIndices = [];
      document.getElementById("result").textContent = "";
      document.getElementById("quizCard").style.display = "block";
      nextQuestion();
    }

    function nextQuestion() {
      if (usedIndices.length === vocab.length) {
        document.getElementById("result").textContent = `ãŠã‚ã‚Šï¼ (${vocab.length - wrongIndices.length} æ­£è§£ / ${vocab.length})`;
        document.getElementById("quizCard").style.display = "none";
        document.getElementById("progress").textContent = "";
        return;
      }
      let index;
      do {
        index = Math.floor(Math.random() * vocab.length);
      } while (usedIndices.includes(index));
      currentIndex = index;
      usedIndices.push(index);
      document.getElementById("question").textContent = vocab[index].kanji;
      document.getElementById("answer").style.display = "none";
      document.getElementById("answer").textContent = vocab[index].reading;
      
      document.getElementById("progress").textContent = `å•é¡Œ ${usedIndices.length} / ${vocab.length}`;
    }

    function showAnswer() {
      document.getElementById("answer").style.display = "block";
    }

    function markCorrect() {
      nextQuestion();
    }

    function markWrong() {
      if (!wrongIndices.includes(currentIndex)) wrongIndices.push(currentIndex);
      nextQuestion();
    }

    function startRetest() {
      if (wrongIndices.length === 0) return alert("é–“é•ãˆãŸå˜èªãŒã‚ã‚Šã¾ã›ã‚“");
      usedIndices = [];
      const wrongVocab = wrongIndices.map(i => vocab[i]);
      vocab = wrongVocab;
      wrongIndices = [];
      document.getElementById("result").textContent = "å†ãƒ†ã‚¹ãƒˆé–‹å§‹";
      document.getElementById("quizCard").style.display = "block";
      nextQuestion();
    }

    function startOver() {
      if (confirm("æœ¬å½“ã«æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ")) {
        usedIndices = [];
        wrongIndices = [];
        document.getElementById("quizCard").style.display = "none";
        document.getElementById("result").textContent = "";
        document.getElementById("progress").textContent = "";
      }
    }

    function exportCSV() {
      if (vocab.length === 0) return alert("å˜èªãŒã‚ã‚Šã¾ã›ã‚“");
      let csv = "kanji,reading\n";
      vocab.forEach(w => {
        csv += `${w.kanji},${w.reading}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "japanese_vocab.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportJSON() {
      if (vocab.length === 0) return alert("å˜èªãŒã‚ã‚Šã¾ã›ã‚“");
      const json = JSON.stringify(vocab, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "japanese_vocab.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData() {
      const input = document.getElementById("importFile");
      if (!input.files.length) {
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
      }
      const file = input.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) throw new Error("å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
          vocab = imported;
          saveData();
          renderVocabList();
          alert("å˜èªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
          input.value = "";
        } catch(err) {
          alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
        }
      };
      reader.readAsText(file);
    }

    function b64EncodeUnicode(str) {
      return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
        function(match, p1) {
          return String.fromCharCode('0x' + p1);
      }));
    }
    function b64DecodeUnicode(str) {
      return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
    }

    function generateShareURL() {
      if (vocab.length === 0) return alert("å˜èªãŒã‚ã‚Šã¾ã›ã‚“");
      const json = JSON.stringify(vocab);
      const encoded = b64EncodeUnicode(json);
      const baseUrl = window.location.href.split('?')[0];
      const shareUrl = `${baseUrl}?data=${encoded}`;
      const input = document.getElementById("shareURL");
      input.value = shareUrl;
      input.select();
      input.setSelectionRange(0, shareUrl.length);
      alert("å…±æœ‰ç”¨URLã‚’ä½œæˆã—ã¾ã—ãŸã€‚ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
    }

    function loadFromURL() {
      const params = new URLSearchParams(window.location.search);
      const data = params.get("data");
      if (data) {
        try {
          const json = b64DecodeUnicode(data);
          const arr = JSON.parse(json);
          if (Array.isArray(arr)) {
            vocab = arr;
            saveData();
            renderVocabList();
            usedIndices = [];
            wrongIndices = [];
            document.getElementById("quizCard").style.display = "none";
            document.getElementById("result").textContent = "";
            document.getElementById("progress").textContent = "";
            alert("URLã‹ã‚‰å˜èªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
          }
        } catch(e) {
          console.error("URLãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å¤±æ•—", e);
        }
      }
    }

    function saveData() {
      localStorage.setItem("japaneseVocab", JSON.stringify(vocab));
    }

    function loadData() {
      const data = localStorage.getItem("japaneseVocab");
      if (data) {
        vocab = JSON.parse(data);
        renderVocabList();
      }
    }

    window.onload = function() {
      loadData();
      loadFromURL();
    };
  </script>
</body>
</html>
