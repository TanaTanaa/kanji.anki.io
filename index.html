<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã«ã»ã‚“ã”ã‚¯ã‚¤ã‚ºï¼ˆç·¨é›†ãƒšãƒ¼ã‚¸ï¼‰</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    padding: 20px;
  }
  textarea, input, button {
    margin: 5px;
    font-size: 16px;
  }
  .card {
    border: 2px solid #ccc;
    border-radius: 12px;
    padding: 20px;
    margin: 20px auto;
    width: 80%;
    max-width: 400px;
    font-size: 24px;
    background: #f9f9f9;
  }
  .word-list {
    margin-top: 20px;
    text-align: left;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
    font-size: 18px;
  }
</style>
</head>
<body>

<h1 id="main-title">ã«ã»ã‚“ã”ã‚¯ã‚¤ã‚ºï¼ˆç·¨é›†ãƒšãƒ¼ã‚¸ï¼‰</h1>

<!-- ç·¨é›†ç”¨ã‚¨ãƒªã‚¢ -->
<div id="edit-area">
  <textarea id="bulkInput" rows="6" cols="50" placeholder="æ¼¢å­—ã€ã‚ˆã¿ã‚’1è¡Œãšã¤å…¥åŠ›ã—ã¦ãã ã•ã„&#10;ä¾‹ï¼‰å·,ã‹ã‚"></textarea><br>
  <button id="addBtn">å˜èªã‚’è¿½åŠ </button>
  <button id="shareBtn">å…±æœ‰ç”¨URLã‚’ä½œæˆ</button><br>
  <input type="text" id="shareURL" readonly style="width:80%" onclick="this.select()" placeholder="ã“ã“ã«å…±æœ‰URLãŒè¡¨ç¤ºã•ã‚Œã¾ã™">

  <h2>ğŸ“š å˜èªãƒªã‚¹ãƒˆ</h2>
  <ul id="vocabList" class="word-list"></ul>
</div>

<!-- ã‚¯ã‚¤ã‚ºç”¨ã‚«ãƒ¼ãƒ‰ -->
<div id="quizCard" class="card" style="display:none;">
  <div id="question"></div>
  <div id="progress" style="margin:10px 0; font-size:18px; color:#555;"></div>
  <button id="showAnswerBtn">ç­”ãˆã‚’è¦‹ã‚‹</button>
  <div id="answer" style="display:none; margin-top:10px; font-size:22px; color:#007700;"></div>
  <button id="correctBtn">â—‹ æ­£è§£</button>
  <button id="wrongBtn">Ã— é–“é•ã„</button>
  <br>
  <button id="restartBtn">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
</div>

<div id="result" style="margin-top:20px; font-size:18px;"></div>

<button id="startQuizBtn">ã‚¯ã‚¤ã‚ºã‚’å§‹ã‚ã‚‹</button>
<button id="retestBtn" style="display:none;">é–“é•ãˆãŸå˜èªã§å†ãƒ†ã‚¹ãƒˆ</button>

<script>
  let vocab = [];
  let currentIndex = 0;
  let usedIndices = [];
  let wrongIndices = [];

  const urlParams = new URLSearchParams(location.search);
  const dataParam = urlParams.get("data");
  const isQuizOnlyMode = !!dataParam;

  // --- UIãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆç·¨é›†ã¨å…±æœ‰ã§å¤‰ãˆã‚‹ï¼‰ ---
  const uiText = {
    edit: {
      add: "å˜èªã‚’è¿½åŠ ",
      share: "å…±æœ‰ç”¨URLã‚’ä½œæˆ",
      showAnswer: "ç­”ãˆã‚’è¦‹ã‚‹",
      correct: "â—‹ æ­£è§£",
      wrong: "Ã— é–“é•ã„",
      restart: "æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™",
      startQuiz: "ã‚¯ã‚¤ã‚ºã‚’å§‹ã‚ã‚‹",
      retest: "é–“é•ãˆãŸå˜èªã§å†ãƒ†ã‚¹ãƒˆ",
      mainTitle: "ã«ã»ã‚“ã”ã‚¯ã‚¤ã‚ºï¼ˆç·¨é›†ãƒšãƒ¼ã‚¸ï¼‰"
    },
    quizOnly: {
      add: "ãŸã‚“ã”ã‚’ã¤ã„ã‹",
      share: "ãã‚‡ã†ã‚†ã†ã‚ˆã†URLã‚’ã¤ãã‚‹",
      showAnswer: "ã“ãŸãˆã‚’ã¿ã‚‹",
      correct: "ã¾ã‚‹ã€€ã›ã„ã‹ã„",
      wrong: "ã°ã¤ã€€ã¾ã¡ãŒã„",
      restart: "ã•ã„ã—ã‚‡ã‹ã‚‰ã‚„ã‚ŠãªãŠã™",
      startQuiz: "ãã„ãšã‚’ã¯ã˜ã‚ã‚‹",
      retest: "ã¾ã¡ãŒãˆãŸãŸã‚“ã”ã§ã•ã„ã¦ã™ã¨",
      mainTitle: "ã«ã»ã‚“ã”ã‚¯ã‚¤ã‚º"
    }
  };

  function setUIText() {
    const t = isQuizOnlyMode ? uiText.quizOnly : uiText.edit;
    document.getElementById("addBtn")?.textContent && (document.getElementById("addBtn").textContent = t.add);
    document.getElementById("shareBtn")?.textContent && (document.getElementById("shareBtn").textContent = t.share);
    document.getElementById("showAnswerBtn").textContent = t.showAnswer;
    document.getElementById("correctBtn").textContent = t.correct;
    document.getElementById("wrongBtn").textContent = t.wrong;
    document.getElementById("restartBtn").textContent = t.restart;
    document.getElementById("startQuizBtn").textContent = t.startQuiz;
    document.getElementById("retestBtn").textContent = t.retest;
    document.getElementById("main-title").textContent = t.mainTitle;
  }

  // --- å˜èªè¿½åŠ  ---
  function addWords() {
    const lines = document.getElementById("bulkInput").value.trim().split("\n");
    for (const line of lines) {
      const [kanji, reading] = line.split(",");
      if (kanji && reading) {
        vocab.push({ kanji: kanji.trim(), reading: reading.trim() });
      }
    }
    renderVocabList();
    alert(isQuizOnlyMode ? "ãŸã‚“ã”ã‚’ã¤ã„ã‹ã—ã¾ã—ãŸ" : "å˜èªã‚’è¿½åŠ ã—ã¾ã—ãŸ");
    document.getElementById("bulkInput").value = "";
  }

  // --- å˜èªãƒªã‚¹ãƒˆè¡¨ç¤º ---
  function renderVocabList() {
    const list = document.getElementById("vocabList");
    list.innerHTML = "";
    vocab.forEach((word, index) => {
      const li = document.createElement("li");
      li.textContent = `${word.kanji} - ${word.reading} `;
      if (!isQuizOnlyMode) {
        const delBtn = document.createElement("button");
        delBtn.textContent = "å‰Šé™¤";
        delBtn.onclick = () => {
          if (confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            vocab.splice(index, 1);
            renderVocabList();
          }
        };
        li.appendChild(delBtn);
      }
      list.appendChild(li);
    });
  }

  // --- ã‚¯ã‚¤ã‚ºé–‹å§‹ ---
  function startQuiz() {
    if (vocab.length === 0) return alert(isQuizOnlyMode ? "ãŸã‚“ã”ãŒã‚ã‚Šã¾ã›ã‚“" : "å˜èªãŒã‚ã‚Šã¾ã›ã‚“");
    usedIndices = [];
    wrongIndices = [];
    document.getElementById("result").textContent = "";
    document.getElementById("quizCard").style.display = "block";
    document.getElementById("startQuizBtn").style.display = "none";
    if (!isQuizOnlyMode) {
      document.getElementById("edit-area").style.display = "none";
      document.getElementById("retestBtn").style.display = "inline-block";
    }
    nextQuestion();
  }

  // --- æ¬¡ã®å•é¡Œ ---
  function nextQuestion() {
    if (usedIndices.length === vocab.length) {
      document.getElementById("result").textContent = `ãŠã‚ã‚Šï¼ (${vocab.length - wrongIndices.length} ã›ã„ã‹ã„ / ${vocab.length})`;
      document.getElementById("quizCard").style.display = "none";
      document.getElementById("progress").textContent = "";
      document.getElementById("startQuizBtn").style.display = "inline-block";
      if (!isQuizOnlyMode) {
        document.getElementById("edit-area").style.display = "block";
        document.getElementById("retestBtn").style.display = "none";
      }
      return;
    }
    let index;
    do {
      index = Math.floor(Math.random() * vocab.length);
    } while (usedIndices.includes(index));
    currentIndex = index;
    usedIndices.push(index);

    // å•é¡Œæ–‡ã¨ç­”ãˆã®è¡¨ç¤ºã¯ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚‹
    if (isQuizOnlyMode) {
      // å•é¡Œæ–‡ï¼šã‚ˆã¿ï¼ˆã²ã‚‰ãŒãªï¼‰
      document.getElementById("question").textContent = vocab[index].reading;
      // ç­”ãˆï¼šæ¼¢å­—ï¼‹èª­ã¿ï¼ˆä¾‹ï¼šã€Œå·ï¼ˆã‹ã‚ï¼‰ã€ï¼‰
      document.getElementById("answer").textContent = vocab[index].kanji + "ï¼ˆ" + vocab[index].reading + "ï¼‰";
    } else {
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¯æ¼¢å­—ã‚’å•é¡Œæ–‡ã€èª­ã¿ã‚’ç­”ãˆ
      document.getElementById("question").textContent = vocab[index].kanji;
      document.getElementById("answer").textContent = vocab[index].reading;
    }
    document.getElementById("answer").style.display = "none";

    document.getElementById("progress").textContent = `å•é¡Œ ${usedIndices.length} / ${vocab.length}`;
  }

  // --- ç­”ãˆã‚’ã¿ã›ã‚‹ ---
  function showAnswer() {
    document.getElementById("answer").style.display = "block";
  }

  // --- æ­£è§£ ---
  function markCorrect() {
    nextQuestion();
  }

  // --- é–“é•ã„ ---
  function markWrong() {
    if (!wrongIndices.includes(currentIndex)) wrongIndices.push(currentIndex);
    nextQuestion();
  }

  // --- é–“é•ãˆãŸå˜èªã§å†ãƒ†ã‚¹ãƒˆ ---
  function startRetest() {
    if (wrongIndices.length === 0) return alert(isQuizOnlyMode ? "ã¾ã¡ãŒãˆãŸãŸã‚“ã”ãŒã‚ã‚Šã¾ã›ã‚“" : "é–“é•ãˆãŸå˜èªãŒã‚ã‚Šã¾ã›ã‚“");
    vocab = wrongIndices.map(i => vocab[i]);
    usedIndices = [];
    wrongIndices = [];
    document.getElementById("result").textContent = isQuizOnlyMode ? "ã•ã„ã¦ã™ã¨ã€€ã‹ã„ã—" : "å†ãƒ†ã‚¹ãƒˆé–‹å§‹";
    document.getElementById("quizCard").style.display = "block";
    document.getElementById("startQuizBtn").style.display = "none";
    nextQuestion();
  }

  // --- æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™ ---
  function startOver() {
    if (confirm(isQuizOnlyMode ? "ã»ã‚“ã¨ã†ã«ã€€ã•ã„ã—ã‚‡ã‹ã‚‰ã‚„ã‚ŠãªãŠã—ã¾ã™ã‹ï¼Ÿ" : "æœ¬å½“ã«æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ")) {
      usedIndices = [];
      wrongIndices = [];
      document.getElementById("quizCard").style.display = "none";
      document.getElementById("result").textContent = "";
      document.getElementById("progress").textContent = "";
      if (!isQuizOnlyMode) {
        document.getElementById("edit-area").style.display = "block";
        document.getElementById("retestBtn").style.display = "none";
      }
      document.getElementById("startQuizBtn").style.display = "inline-block";
    }
  }

  // --- å…±æœ‰ç”¨URLç”Ÿæˆ ---
  function shareURL() {
    if (vocab.length === 0) return alert("å˜èªã‚’è¿½åŠ ã—ã¦ãã ã•ã„");
    const json = JSON.stringify(vocab);
    const encoded = encodeURIComponent(btoa(unescape(encodeURIComponent(json))));
    const url = `${location.origin}${location.pathname}?data=${encoded}`;
    const input = document.getElementById("shareURL");
    input.value = url;
    input.select();
    navigator.clipboard.writeText(url);
    alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  }

  // --- URLã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
  function loadFromURL() {
    if (!isQuizOnlyMode) {
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰
      const saved = localStorage.getItem("nihongoVocab");
      if (saved) {
        try {
          vocab = JSON.parse(saved);
          renderVocabList();
        } catch {}
      }
    } else {
      // ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã¯URLã‹ã‚‰
      try {
        const decoded = decodeURIComponent(escape(atob(decodeURIComponent(dataParam))));
        vocab = JSON.parse(decoded);
        // ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´
        document.getElementById("main-title").textContent = uiText.quizOnly.mainTitle;
        // ç·¨é›†ã‚¨ãƒªã‚¢éš ã™
        document.getElementById("edit-area").style.display = "none";
        // å†ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³è¡¨ç¤º
        document.getElementById("retestBtn").style.display = "inline-block";
        // ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³è¡¨ç¤º
        document.getElementById("startQuizBtn").style.display = "inline-block";
        // ãƒœã‚¿ãƒ³ã®æ—¥æœ¬èªå¤‰æ›´
        setUIText();
      } catch {
        alert("URLã®å†…å®¹ãŒå£Šã‚Œã¦ã„ã¾ã™");
      }
    }
  }

  // --- åˆæœŸè¨­å®š ---
  window.onload = () => {
    setUIText();
    loadFromURL();
  };

  // --- ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰ ---
  window.onbeforeunload = () => {
    if (!isQuizOnlyMode) {
      localStorage.setItem("nihongoVocab", JSON.stringify(vocab));
    }
  };

  // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
  document.getElementById("addBtn")?.addEventListener("click", addWords);
  document.getElementById("shareBtn")?.addEventListener("click", shareURL);
  document.getElementById("startQuizBtn").addEventListener("click", startQuiz);
  document.getElementById("retestBtn").addEventListener("click", startRetest);
  document.getElementById("showAnswerBtn").addEventListener("click", showAnswer);
  document.getElementById("correctBtn").addEventListener("click", markCorrect);
  document.getElementById("wrongBtn").addEventListener("click", markWrong);
  document.getElementById("restartBtn").addEventListener("click", startOver);
</script>

</body>
</html>
