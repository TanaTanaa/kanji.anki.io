<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ことばクイズ</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    textarea, input, button, select { margin: 5px; font-size: 16px; }
    .hide { display: none; }
    .card { border: 1px solid #ccc; padding: 20px; margin: 10px; border-radius: 8px; }
  </style>
</head>
<body>

<h1>ことばクイズ</h1>

<div id="edit-area">
  <textarea id="wordList" rows="10" cols="50" placeholder="たとえば：กิน,たべる"></textarea><br>
  <button onclick="loadWords()">たんごを とうろく</button>
</div>

<select id="quizType">
  <option value="thaiToJapanese">A → B</option>
  <option value="japaneseToThai">B → A</option>
</select><br>

<button onclick="startQuiz()">くいずを はじめる</button>
<button onclick="resetQuiz()">もういちど くいずを やる</button>
<button onclick="startRetest()">まちがい さいちょうせん</button>
<button onclick="startEverWrongQuiz()">まちがえたたんごで ふくしゅう</button><br><br>

<div id="quizCard" class="card hide">
  <div id="question"></div>
  <button onclick="showAnswer()">こたえを みる</button><br>
  <div id="answer" class="hide"></div><br>
  <button onclick="markAnswer(true)">○</button>
  <button onclick="markAnswer(false)">×</button>
</div>

<div id="result"></div>

<script>
let vocab = [];
let originalVocab = [];
let currentIndex = 0;
let usedIndices = [];
let correctCount = 0;
let wrongIndices = [];
let everWrongIndices = new Set();
let resultLog = [];
let isRetest = false;

function loadWords() {
  const input = document.getElementById("wordList").value.trim();
  if (!input) return;

  vocab = input.split('\n').map((line, i) => {
    const [thai, japanese] = line.split(',').map(s => s.trim());
    return { thai, japanese, __originalIndex: i };
  });
  originalVocab = [...vocab];
  document.getElementById("edit-area").classList.add("hide");
  document.getElementById("quizCard").classList.remove("hide");
  startQuiz();
}

function loadFromURL() {
  const p = new URLSearchParams(location.search).get("data");
  if (p) {
    try {
      const decoded = decodeURIComponent(escape(atob(decodeURIComponent(p))));
      originalVocab = JSON.parse(decoded);
      vocab = originalVocab.map((w, i) => Object.assign({}, w, { __originalIndex: i }));
      document.getElementById("edit-area").classList.add("hide");
      document.getElementById("quizCard").classList.remove("hide");
      startQuiz();
    } catch {
      alert("URLの ないようが こわれています");
    }
  }
}

function startQuiz() {
  usedIndices = [];
  wrongIndices = [];
  correctCount = 0;
  resultLog = [];
  isRetest = false;
  nextQuestion();
}

function resetQuiz() {
  vocab = originalVocab.map((w, i) => Object.assign({}, w, { __originalIndex: i }));
  startQuiz();
}

function startRetest() {
  if (wrongIndices.length === 0) return alert("まちがえたもんだいが ありません");
  vocab = wrongIndices.map(i => Object.assign({}, originalVocab[i], { __originalIndex: i }));
  usedIndices = [];
  wrongIndices = [];
  correctCount = 0;
  resultLog = [];
  isRetest = true;
  document.getElementById("result").textContent = "まちがい さいちょうせん を はじめます";
  document.getElementById("quizCard").classList.remove("hide");
  nextQuestion();
}

function startEverWrongQuiz() {
  if (everWrongIndices.size === 0) return alert("まちがえたたんごが ありません");
  vocab = [...everWrongIndices].map(i => Object.assign({}, originalVocab[i], { __originalIndex: i }));
  usedIndices = [];
  wrongIndices = [];
  correctCount = 0;
  resultLog = [];
  isRetest = true;
  document.getElementById("result").textContent = "まちがえたたんごで ふくしゅう を はじめます";
  document.getElementById("quizCard").classList.remove("hide");
  nextQuestion();
}

function nextQuestion() {
  if (usedIndices.length === vocab.length) {
    document.getElementById("question").textContent = "ぜんぶ おわりました！ せいかい：" + correctCount + "/" + vocab.length;
    document.getElementById("answer").classList.add("hide");
    return;
  }

  let i;
  do {
    i = Math.floor(Math.random() * vocab.length);
  } while (usedIndices.includes(i));

  currentIndex = i;
  usedIndices.push(i);

  const quizType = document.getElementById("quizType").value;
  const current = vocab[i];
  document.getElementById("question").textContent =
    quizType === "thaiToJapanese" ? current.thai : current.japanese;

  document.getElementById("answer").textContent =
    quizType === "thaiToJapanese" ? current.japanese : current.thai;

  document.getElementById("answer").classList.add("hide");
}

function showAnswer() {
  document.getElementById("answer").classList.remove("hide");
}

function markAnswer(correct) {
  const current = vocab[currentIndex];
  const originalIndex = current.__originalIndex;
  if (!correct) {
    wrongIndices.push(originalIndex);
    everWrongIndices.add(originalIndex);
  } else {
    correctCount++;
  }
  resultLog.push({ ...current, correct });
  nextQuestion();
}

loadFromURL();
</script>

</body>
</html>

