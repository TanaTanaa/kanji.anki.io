<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã«ã»ã‚“ã”ãã„ãš</title>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    textarea, input, button { margin: 5px; font-size: 16px; }
    .card { border: 2px solid #ccc; border-radius: 12px; padding: 20px; margin:20px auto; width:80%; max-width:400px; font-size:24px; }
    .word-list { margin-top:20px; text-align:left; max-width:500px; margin:auto; font-size:18px; }
    .hide { display: none; }
  </style>
</head>
<body>
  <h1>ã«ã»ã‚“ã”ãã„ãš</h1>

  <div id="edit-area">
    <textarea id="bulkInput" rows="6" cols="50" placeholder="ã‹ã‚“ã˜,ã‚ˆã¿ ã‚’ ã‹ã„ãã‚‡ã†ã§ ã«ã‚…ã†ã‚Šã‚‡ã&#10;ã‚Œã„ï¼‰å·,ã‹ã‚"></textarea><br>
    <button onclick="addWords()">ãŸã‚“ã”ã‚’ ã¤ã„ã‹</button>
    <button onclick="shareURL()">ãã‚‡ã†ã‚†ã†ã‚ˆã†URLã‚’ ã¤ãã‚‹</button><br>
    <input type="text" id="shareURL" readonly style="width:80%" onclick="this.select()" placeholder="ã“ã“ã«URLãŒ ã²ã‚‡ã†ã˜ã•ã‚Œã¾ã™">
    <h2>ğŸ“š ãŸã‚“ã”ã‚Šã™ã¨</h2>
    <ul id="vocabList" class="word-list"></ul>
  </div>

  <div id="quizCard" class="card hide">
    <div id="question"></div>
    <div id="progress" style="margin:10px 0; font-size:18px; color:#555;"></div>
    <button onclick="showAnswer()">ã“ãŸãˆã‚’ ã¿ã‚‹</button>
    <div id="answer" style="display:none; margin-top:10px; font-size:22px; color:#007700;"></div>
  </div>

  <div id="result" style="margin-top:20px; font-size:18px;"></div>
  <button onclick="startQuiz()">ãã„ãšã‚’ ã¯ã˜ã‚ã‚‹</button>
  <button onclick="startRetest()">ã¾ã¡ãŒãˆãŸ ã‚‚ã‚“ã ã„ã§ ã•ã„ã¡ã‚‡ã†ã›ã‚“</button>
  <button onclick="resetQuiz()">ã‚‚ã†ã„ã¡ã© ãã„ãšã‚’ ã‚„ã‚‹</button>

<script>
  let vocab = [];
  let currentIndex = 0, usedIndices = [], wrongIndices = [];

  function addWords(){
    const lines = document.getElementById("bulkInput").value.trim().split("\n");
    lines.forEach(line=>{
      let [kanji, reading] = line.split(",");
      if(kanji && reading){
        vocab.push({ kanji:kanji.trim(), reading:reading.trim() });
      }
    });
    renderVocabList();
    alert("ãŸã‚“ã”ã‚’ ã¤ã„ã‹ã—ã¾ã—ãŸ");
  }

  function renderVocabList(){
    const ul = document.getElementById("vocabList"); ul.innerHTML = "";
    vocab.forEach((w,i)=>{
      const li = document.createElement("li");
      li.textContent = `${w.kanji} - ${w.reading} `;
      const del = document.createElement("button");
      del.textContent="ã•ãã˜ã‚‡"; del.onclick=()=>{
        vocab.splice(i,1);
        renderVocabList();
      };
      li.appendChild(del);
      ul.appendChild(li);
    });
  }

  function startQuiz(){
    if(vocab.length===0) return alert("ãŸã‚“ã”ãŒ ã‚ã‚Šã¾ã›ã‚“");
    usedIndices = []; wrongIndices = []; document.getElementById("result").textContent="";
    document.getElementById("quizCard").classList.remove("hide");
    nextQuestion();
  }

  function nextQuestion(){
    if(usedIndices.length>=vocab.length){
      document.getElementById("result").textContent = `ãŠã‚ã‚Šï¼`;
      document.getElementById("quizCard").classList.add("hide");
      document.getElementById("progress").textContent="";
      return;
    }
    let idx;
    do{ idx = Math.floor(Math.random()*vocab.length); }while(usedIndices.includes(idx));
    currentIndex=idx; usedIndices.push(idx);
    const w = vocab[idx];
    document.getElementById("question").textContent = w.kanji;
    document.getElementById("answer").style.display="none";
    document.getElementById("answer").textContent = w.reading;
    document.getElementById("progress").textContent = `ã‚‚ã‚“ã ã„ ${usedIndices.length} / ${vocab.length}`;
  }

  function showAnswer(){ document.getElementById("answer").style.display="block"; }

  function startRetest(){
    if(wrongIndices.length===0) return alert("ã¾ã¡ãŒãˆãŸ ãŸã‚“ã”ãŒ ã‚ã‚Šã¾ã›ã‚“");
    vocab = wrongIndices.map(i=>vocab[i]);
    usedIndices = []; wrongIndices = [];
    document.getElementById("result").textContent = "ã•ã„ã¡ã‚‡ã†ã›ã‚“ ã‹ã„ã—";
    document.getElementById("quizCard").classList.remove("hide");
    nextQuestion();
  }

  function resetQuiz(){
    usedIndices = [];
    wrongIndices = [];
    document.getElementById("result").textContent = "ã‚‚ã†ã„ã¡ã© ãã„ãšã‚’ ã¯ã˜ã‚ã¾ã™";
    document.getElementById("quizCard").classList.remove("hide");
    nextQuestion();
  }

  function shareURL(){
    if(vocab.length===0)return alert("ãŸã‚“ã”ã‚’ ã¤ã„ã‹ã—ã¦ãã ã•ã„");
    const json = JSON.stringify(vocab);
    const encoded = encodeURIComponent(btoa(unescape(encodeURIComponent(json))));
    const url = `${location.origin}${location.pathname}?data=${encoded}`;
    const input = document.getElementById("shareURL");
    input.value = url; input.select();
    navigator.clipboard.writeText(url);
    alert("URLã‚’ ã“ã´ãƒ¼ã—ã¾ã—ãŸ");
  }

  function loadFromURL(){
    const p = new URLSearchParams(location.search).get("data");
    if(p){
      try {
        const decoded = decodeURIComponent(escape(atob(decodeURIComponent(p))));
        vocab = JSON.parse(decoded);
        document.getElementById("edit-area").classList.add("hide");
        currentIndex = 0; usedIndices=[]; wrongIndices=[];
        document.getElementById("quizCard").classList.remove("hide");
        nextQuestion();
      } catch {
        alert("URLã® ãªã„ã‚ˆã†ãŒ ã“ã‚ã‚Œã¦ã„ã¾ã™");
      }
    }
  }

  window.onload = loadFromURL;
</script>
</body>
</html>
