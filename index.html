<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>にほんごクイズ</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    .card {
      border: 2px solid #ccc;
      border-radius: 12px;
      padding: 20px;
      margin: 10px auto;
      width: 90%;
      max-width: 400px;
      font-size: 24px;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
    }
    textarea {
      width: 90%;
      height: 100px;
      font-size: 16px;
    }
    #answer {
      margin: 10px;
      font-size: 20px;
      color: green;
      display: none;
    }
  </style>
</head>
<body>
  <h1 id="title">にほんごクイズ（じこはんていしき）</h1>

  <div id="input-area">
    <textarea id="word-input" placeholder="れい：木,き\n（かんじ,よみ　を1行ずつ）"></textarea><br />
    <button onclick="addWords()">たんごをついか</button>
    <button onclick="clearWords()">すべてけす</button><br />
    <button onclick="startQuiz()">クイズをはじめる</button><br />
    <p>このURLをコピーして、スマホなどであけてください：</p>
    <textarea id="share-url" readonly onclick="this.select()"></textarea>
  </div>

  <div id="quiz-area" style="display:none;">
    <div class="card">
      <div id="progress"></div>
      <div id="question" style="margin:20px; font-size:32px;"></div>
      <div id="answer"></div>
    </div>
    <button onclick="showAnswer()" id="show-answer">こたえをみる</button>
    <button onclick="markCorrect()" id="btn-correct" style="display:none;">○ せいかい</button>
    <button onclick="markWrong()" id="btn-wrong" style="display:none;">× まちがい</button>
    <br />
    <button onclick="restartQuiz()">さいしょから</button>
    <div id="result" style="margin-top: 20px;"></div>
  </div>

  <script>
    let words = [];
    let currentIndex = 0;
    let usedIndices = [];
    let wrongIndices = [];

    function parseQuery() {
      const params = new URLSearchParams(location.search);
      if (params.has("data")) {
        try {
          const decoded = decodeURIComponent(atob(params.get("data")));
          words = JSON.parse(decoded);
          document.getElementById("title").textContent = "にほんごくいず";
          document.getElementById("input-area").style.display = "none";
          startQuiz();
        } catch (e) {
          alert("URLのデータがこわれています");
        }
      }
    }

    function addWords() {
      const input = document.getElementById("word-input").value.trim();
      const lines = input.split("\n");
      for (const line of lines) {
        const [kanji, reading] = line.split(",");
        if (kanji && reading) {
          words.push({ kanji: kanji.trim(), reading: reading.trim() });
        }
      }
      updateURL();
      document.getElementById("word-input").value = "";
    }

    function clearWords() {
      if (confirm("ほんとうにけしますか？")) {
        words = [];
        updateURL();
      }
    }

    function updateURL() {
      const json = JSON.stringify(words);
      const encoded = btoa(encodeURIComponent(json));
      const url = `${location.origin}${location.pathname}?data=${encoded}`;
      document.getElementById("share-url").value = url;
    }

    function startQuiz() {
      if (words.length === 0) return alert("たんごがありません");
      currentIndex = 0;
      usedIndices = [];
      wrongIndices = [];
      document.getElementById("quiz-area").style.display = "block";
      showQuestion();
    }

    function restartQuiz() {
      currentIndex = 0;
      usedIndices = [];
      wrongIndices = [];
      showQuestion();
    }

    function showQuestion() {
      if (usedIndices.length === words.length) {
        document.getElementById("question").textContent = "おわり！";
        document.getElementById("answer").style.display = "none";
        document.getElementById("show-answer").style.display = "none";
        document.getElementById("btn-correct").style.display = "none";
        document.getElementById("btn-wrong").style.display = "none";
        document.getElementById("result").textContent = `せいかい：${words.length - wrongIndices.length} / ${words.length}`;
        return;
      }

      let index;
      do {
        index = Math.floor(Math.random() * words.length);
      } while (usedIndices.includes(index));

      currentIndex = index;
      usedIndices.push(index);

      document.getElementById("question").textContent = words[index].kanji;
      document.getElementById("answer").textContent = words[index].reading;
      document.getElementById("answer").style.display = "none";
      document.getElementById("show-answer").style.display = "inline-block";
      document.getElementById("btn-correct").style.display = "none";
      document.getElementById("btn-wrong").style.display = "none";

      document.getElementById("progress").textContent = `もんだい ${usedIndices.length} / ${words.length}`;
      document.getElementById("result").textContent = "";
    }

    function showAnswer() {
      document.getElementById("answer").style.display = "block";
      document.getElementById("show-answer").style.display = "none";
      document.getElementById("btn-correct").style.display = "inline-block";
      document.getElementById("btn-wrong").style.display = "inline-block";
    }

    function markCorrect() {
      showQuestion();
    }

    function markWrong() {
      if (!wrongIndices.includes(currentIndex)) wrongIndices.push(currentIndex);
      showQuestion();
    }

    parseQuery();
  </script>
</body>
</html>

